<!doctype html><html lang="en"
   data-mode="dark">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>vCenter 4.1 Upgrade Woes | blog... things...</title><link rel="apple-touch-icon" href="/images/favicons/apple-touch-icon.png" sizes="180x180">
<link rel="icon" href="/images/favicons/favicon-32x32.png" sizes="32x32" type="image/png">
<link rel="icon" href="/images/favicons/favicon-16x16.png" sizes="16x16" type="image/png">
<link rel="manifest" href="/images/favicons/manifest.json">
<link rel="icon" href="/images/favicons/favicon.ico">
<meta name="keywords" content="" />
<meta name="description" content="" /><meta itemprop="name" content="vCenter 4.1 Upgrade Woes">
<meta itemprop="description" content="Recently while upgrading a customers vCenter database to 4.1 from 4.0 I ran in to this gem of a problem. The problem is created when you change the schema of the account that accesses the database. So if you have a user that is in the dbo schema then you change that user to something like VPXAdmin for the schema the upgrade will break on you. When using the regular installer we received a message that the schema&rsquo;s did not match."><meta itemprop="datePublished" content="2010-09-09T00:00:00+00:00" />
<meta itemprop="dateModified" content="2010-09-09T00:00:00+00:00" />
<meta itemprop="wordCount" content="683">
<meta itemprop="keywords" content="" /><meta property="og:title" content="vCenter 4.1 Upgrade Woes" />
<meta property="og:description" content="Recently while upgrading a customers vCenter database to 4.1 from 4.0 I ran in to this gem of a problem. The problem is created when you change the schema of the account that accesses the database. So if you have a user that is in the dbo schema then you change that user to something like VPXAdmin for the schema the upgrade will break on you. When using the regular installer we received a message that the schema&rsquo;s did not match." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/2010-09-09-201099vcenter-41-upgrade-woes-html/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2010-09-09T00:00:00+00:00" />
<meta property="article:modified_time" content="2010-09-09T00:00:00+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="vCenter 4.1 Upgrade Woes"/>
<meta name="twitter:description" content="Recently while upgrading a customers vCenter database to 4.1 from 4.0 I ran in to this gem of a problem. The problem is created when you change the schema of the account that accesses the database. So if you have a user that is in the dbo schema then you change that user to something like VPXAdmin for the schema the upgrade will break on you. When using the regular installer we received a message that the schema&rsquo;s did not match."/>
<link rel="preload" href="/css/bundle.min.56f818f19e58c97481c8333650e24bf131abfada62c954646a72ae940adb3bf5.css" integrity="sha256-VvgY8Z5YyXSByDM2UOJL8TGr&#43;tpiyVRkanKulArbO/U=" crossorigin="anonymous" as="style" onload="this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="/css/bundle.min.56f818f19e58c97481c8333650e24bf131abfada62c954646a72ae940adb3bf5.css" integrity="sha256-VvgY8Z5YyXSByDM2UOJL8TGr&#43;tpiyVRkanKulArbO/U=" crossorigin="anonymous"></noscript></head>
  <body><script src="/js/bootstrap.min.b5d86dd3a5f60c90be38a252bb65fc1a2732f32e71dc12c051720f0c7aef3cde.js" integrity="sha256-tdht06X2DJC&#43;OKJSu2X8Gicy8y5x3BLAUXIPDHrvPN4=" crossorigin="anonymous"></script><header><nav class="navbar top-app-bar top-app-bar-expand-lg fixed-top">
  <div class="container">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
      aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <i class="fas fa-bars"></i>
    </button><a class="navbar-brand me-3" href="/"><img class="logo" alt="Logo" src="/images/logo.png" loading="lazy"
   width="400" height="400"
   />
blog... things...
    </a>
    <button class="navbar-social-share" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasSocialShare"
  aria-controls="offcanvasSocialShare" aria-label="Toggle social share">
  <i class="fas fa-share-alt"></i>
</button>

<div class="offcanvas offcanvas-bottom surface" tabindex="-1" id="offcanvasSocialShare" aria-labelledby="offcanvasSocialShare">
  <div class="offcanvas-header">
    <h3 class="offcanvas-title">Share</h3>
    <button type="button" class="btn btn-sm btn-outline-primary" data-bs-dismiss="offcanvas" aria-label="Close">
      <i class="fas fa-times"></i>
    </button>
  </div>
  <div class="offcanvas-body">
    <a class="btn btn-sm btn-outline-primary social-share-button" rel="noopener noreferrer" aria-label="Twitter Share Button"
      target="_blank" href="https://twitter.com/intent/tweet?title=vCenter%204.1%20Upgrade%20Woes&url=%2fposts%2f2010-09-09-201099vcenter-41-upgrade-woes-html%2f">
      <i class="fab fa-fw fa-twitter"></i> Twitter
    </a>
    <a class="btn btn-sm btn-outline-primary social-share-button" rel="noopener noreferrer" aria-label="Facebook Share Button"
      target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=%2fposts%2f2010-09-09-201099vcenter-41-upgrade-woes-html%2f">
      <i class="fab fa-fw fa-facebook-f"></i> Facebook
    </a>
  </div>
</div>

    <button class="navbar-settings" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasSettings"
  aria-controls="offcanvasSettings" aria-label="Toggle settings">
  <i class="fas fa-ellipsis-v"></i>
</button>

<div class="offcanvas offcanvas-end surface h-100" tabindex="-1" id="offcanvasSettings" aria-labelledby="offcanvasSettings">
  <div class="offcanvas-header">
    <h3 class="offcanvas-title">Settings</h3>
    <button type="button" class="btn btn-sm btn-outline-primary" data-bs-dismiss="offcanvas" aria-label="Close">
      <i class="fas fa-times"></i>
    </button>
  </div>
  <div class="offcanvas-body">



<section class="setting">
  <form class="font-size-switcher-form row">
    <div class="col-auto">
      <label for="fontSize" class="form-label"><i class="fas fa-fw fa-font"></i> Font Size</label>
    </div>
    <div class="col-auto ms-auto">
      <input type="range" class="form-range" min="-2" max="2" id="fontSize">
    </div>
  </form>
</section>


<section class="setting palettes">
  <form class="row">
    <div class="col-auto">
      <label><i class="fas fa-fw fa-palette"></i> Palette</label>
    </div>
    <div class="col-auto ms-auto">
      <a id="btnPalette" class="btn btn-sm btn-outline-primary" role="button" aria-label="palettePicker">
        <i class="fas fa-eye-dropper"></i>
      </a>
    </div>
  </form>
  <div class="mt-2 d-flex visually-hidden" id="palettePicker"><button type="button" id="palette-blue" aria-label="Blue"
        class="btn btn-sm palette" data-palette="blue">
      </button><button type="button" id="palette-blue-gray" aria-label="Blue Gray"
        class="btn btn-sm palette" data-palette="blue-gray">
      </button><button type="button" id="palette-brown" aria-label="Brown"
        class="btn btn-sm palette" data-palette="brown">
      </button><button type="button" id="palette-cyan" aria-label="Cyan"
        class="btn btn-sm palette" data-palette="cyan">
      </button><button type="button" id="palette-green" aria-label="Green"
        class="btn btn-sm palette" data-palette="green">
      </button><button type="button" id="palette-indigo" aria-label="Indigo"
        class="btn btn-sm palette" data-palette="indigo">
      </button><button type="button" id="palette-orange" aria-label="Orange"
        class="btn btn-sm palette" data-palette="orange">
      </button><button type="button" id="palette-pink" aria-label="Pink"
        class="btn btn-sm palette" data-palette="pink">
      </button><button type="button" id="palette-purple" aria-label="Purple"
        class="btn btn-sm palette" data-palette="purple">
      </button><button type="button" id="palette-red" aria-label="Red"
        class="btn btn-sm palette" data-palette="red">
      </button><button type="button" id="palette-teal" aria-label="Teal"
        class="btn btn-sm palette" data-palette="teal">
      </button><button type="button" id="palette-yellow" aria-label="Yellow"
        class="btn btn-sm palette" data-palette="yellow">
      </button></div>
</section>
</div>
</div>

    <div class="collapse navbar-collapse" tabindex="-1" id="navbarSupportedContent" aria-labelledby="navbarSupportedContent">
      <form class="search-bar my-1" action="/search">
  <div class="input-group input-group-sm">
    <span class="btn btn-search disabled position-absolute left-0"><i class="fas fa-fw fa-search"></i></span>
    <input class="form-control rounded-pill" name="q" type="search" aria-label="Search">
  </div>
</form>

      <ul class="navbar-nav ms-auto"><li class="nav-item dropdown">
          <a class="nav-link" id="navbarDropdown-dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="fas fa-fw fa-chevron-circle-down"></i>menu
          </a>
          <ul class="dropdown-menu" aria-labelledby="navbarDropdown-dropdown"><li>
              <a class="dropdown-item"
                href="https://github.com/virtualserverguy" target="_blank" rel="noopener noreferrer">
                <i class="fab fa-fw fa-github"></i>Github
              </a>
            </li></ul>
        </li></ul>
    </div>
  </div>
</nav>
</header>
<main role="main" class="container">
      <div class="row content">
<div class="col-lg-8">
  <div class="container"><nav class="row card component" aria-label="breadcrumb">
  <div class="card-body">
    <ol class="breadcrumb "><li class="breadcrumb-item"><a href="/">Home</a></li><li class="breadcrumb-item"><a href="/posts/">Posts</a></li><li class="breadcrumb-item active">vCenter 4.1 Upgrade Woes</li></ol>
  </div>
</nav>    <article class="row card component mb-4 post"><div class="post-panel-wrapper">
  <div class="d-flex flex-column component rounded post-panel">
    
    <a id="sidebarToggler" class="action d-none d-lg-block" role="button">
  <i class="fas fa-fw fa-expand-alt" data-fa-transform="rotate-45"></i>
</a>
  
    

    
    <a class="action" data-bs-container="body" data-bs-toggle="popover" data-bs-html="true" data-bs-placement="bottom"
  data-bs-trigger="focus" tabindex="0" role="button" aria-label="Copyright" 
  data-bs-content="&lt;a target=&#34;_blank&#34; rel=&#34;license noopener noreferrer&#34; href=&#34;https://creativecommons.org/licenses/by-nc-nd/4.0/deed.en&#34;&gt;CC BY-NC-ND 4.0 &lt;i class=&#34;fab fa-fw fa-creative-commons&#34;&gt;&lt;/i&gt;&lt;i class=&#34;fab fa-fw fa-creative-commons-by&#34;&gt;&lt;/i&gt;&lt;i class=&#34;fab fa-fw fa-creative-commons-nc&#34;&gt;&lt;/i&gt;&lt;i class=&#34;fab fa-fw fa-creative-commons-nd&#34;&gt;&lt;/i&gt;&lt;/a&gt;
">
  <i class="fas fa-fw fa-copyright"></i>
</a>
    
    
  </div>
</div>
<div class="card-body">
        <h1 class="card-title my-3">vCenter 4.1 Upgrade Woes
</h1><div class="post-meta"><span class="post-date" title="created on">
    <i class="fas fa-fw fa-calendar-alt"></i>Sep 9, 2010
  </span><span class="post-reading-time" title="reading time">
    <i class="fas fa-fw fa-coffee"></i>4 min read
  </span><a href="/categories/vmware-vsphere/" class="badge rounded-pill text-white bg-primary post-taxonomy">vmware-vsphere</a></div>
<div class="post-content mb-3"><p>Recently while upgrading a customers vCenter database to 4.1 from 4.0 I ran in to this gem of a problem.  The problem is created when you change the schema of the account that accesses the database.  So if you have a user that is in the dbo schema then you change that user to something like VPXAdmin for the schema the upgrade will break on you.  When using the regular installer we received a message that the schema&rsquo;s did not match.</p>
<p>So normally you should login to SQL and verify that the schema&rsquo;s match or that it didn&rsquo;t change on you.  But if for some reason you sign in and don&rsquo;t see anything wrong here is some more steps to lead you down a rabbit hole.</p>
<p>To complete a DB upgrade without using the full fledged installed you can run the VCDatabaseUpgrade utility from the installation media under the vpxdbupgradebin directory.  The command to use is like this</p>
<blockquote>
<p>VCDatabaseUpgrade.exe DSN=<!-- raw HTML omitted --> UID=<!-- raw HTML omitted --> PWD=<!-- raw HTML omitted --></p>
</blockquote>
<p>This will attempt to run the wizard as that user; if for some reason nothing happens you should check out the logs in this location (the username is the user that is attempting to launch the utility which may not be the same user that has DB rights):</p>
<p>Windows 2008 and newer:</p>
<blockquote>
<p>C:Users<!-- raw HTML omitted -->AppDataLocalTemp2</p>
</blockquote>
<p>Windows 2003:</p>
<blockquote>
<p>C:Documents and Settings<!-- raw HTML omitted -->Application DataLocalTemp2</p>
</blockquote>
<p>This log file will show something such as:</p>
<blockquote>
<p>[9/8/2010 4:10:39 PM] Initialize failed, exiting&hellip;<br>
[9/8/2010 4:10:45 PM] Info: Beginning upgrade process&hellip;.<br>
[9/8/2010 4:10:45 PM] Info: vCenterTest_SQLNativev10 has been detected as a SQL server.</p>
<p>[9/8/2010 4:10:45 PM] Error: ERROR [28000] [Microsoft][SQL Server Native Client 10.0][SQL Server]Login failed for user &lsquo;administrator&rsquo;.<br>
ERROR [28000] [Microsoft][SQL Server Native Client 10.0][SQL Server]Login failed for user &lsquo;administrator&rsquo;.</p>
</blockquote>
<p>If the wizard starts up click next and start.  If all goes well then it will upgrade your database without any issue or error (but then again you wouldn&rsquo;t be reading this if you didn&rsquo;t have an error).  The mismatched schema causes issues about 3/4 of the way through the first file with this line in the logs:</p>
<blockquote>
<p>create table vpx_device_tmp (DEVICE_ID NUMERIC(38) identity(0,1), DEVICE_NAME nvarchar(255))<br>
SET IDENTITY_INSERT dbo.vpx_device_tmp ON</p>
</blockquote>
<p>What quickly stuck out at me is that the script is creating a table vpx_device_tmp without specifying the schema to use, meaning that it uses the users default (which in my case had been changed).  So instead of getting a table with dbo.vpx_device_tmp we get something like VPXAdmin.vpx_device_tmp; which then breaks on the very next command when SQL tries to locate and set the Identity on the table.</p>
<p>So how do we fix this little problem?</p>
<p>First we need to roll back the database to pre-upgrade status (that is why you took a backup prior to starting this process!  Sure we could continue from here but there is about 700 lines of SQL code that need to be backed out otherwise you will get errors when attempting to re-run it such as this error:</p>
<blockquote>
<p>ALTER TABLE VPX_HOST ADD BOOT_TIME_ON_HOST NUMERIC(21) null</p>
<p>[9/8/2010 4:18:16 PM] Error: Failed to execute command: ALTER TABLE VPX_HOST ADD BOOT_TIME_ON_HOST NUMERIC(21) null</p>
<p>[9/8/2010 4:18:16 PM] Got exception: ERROR [42S21] [Microsoft][SQL Server Native Client 10.0][SQL Server]Column names in each table must be unique. Column name &lsquo;BOOT_TIME_ON_HOST&rsquo; in table &lsquo;VPX_HOST&rsquo; is specified more than once.</p>
<p>[9/8/2010 4:18:16 PM] Error while upgrading: ERROR [42S21] [Microsoft][SQL Server Native Client 10.0][SQL Server]Column names in each table must be unique. Column name &lsquo;BOOT_TIME_ON_HOST&rsquo; in table &lsquo;VPX_HOST&rsquo; is specified more than once.</p>
<p>[9/8/2010 4:18:16 PM] Info: Exiting Upgrade Wizard</p>
<p>[9/8/2010 4:20:59 PM] Info: Flushing all logs and quitting application.</p>
</blockquote>
<p>So after we roll back, we need to modify the default schema from the incorrect value to the dbo value that it was installed with.  Once that is complete re-start the upgrade and watch as it completes without error (unless you are really unlucky).</p>
<p>VMware probably should have caught this problem in QA but since it is a pretty bizarre test case I am sure they will add it next time, :).  Or they could just make sure to use fully qualified tables in their upgrade scripts and not even have to worry about something like this.</p>
</div><hr /><div class="post-navs d-flex mb-3 justify-content-evenly">
  <div class="post-nav post-prev"><i class="fas fa-fw fa-chevron-left"></i>
    <a href="/posts/2010-09-07-201097vcdx-51-html/">VCDX 51
</a>
  </div><div class="post-nav post-next">
    <a href="/posts/2010-09-21-2010921vcenter-41-adam_vmwarevcmsds-error-html/">vCenter 4.1 ADAM_VMwareVCMSDS Error
</a>
    <i class="fas fa-fw fa-chevron-right"></i>
  </div></div><section class="related-posts-wrapper">
    <h3>Related Posts</h3>
    <ul class="related-posts"><li><a href="/posts/2010-09-07-201097vcdx-51-html/">VCDX 51
</a></li><li><a href="/posts/2010-09-03-201093vmwares-new-license-structure-html/">VMware&#39;s New License Structure
</a></li><li><a href="/posts/2010-09-03-201093vmworld-2010-is-over-so-html/">VMworld 2010 is over... So?
</a></li><li><a href="/posts/2010-08-19-2010819how-to-test-vmkernel-connectivity-html/">How to test vmKernel connectivity
</a></li><li><a href="/posts/2010-08-19-2010819vmotion-changes-in-vsphere-41-html/">vMotion Changes in vSphere 4.1
</a></li></ul>
  </section></div>
    </article><div class="card component row post-comments">
  <div class="card-body"></div>
</div></div>
</div><aside class="col-lg-4 sidebar d-flex">
  <div class="container">
    
    <section class="card row text-center profile component">
  <div class="card-body">
    <div class="col-12 d-flex align-items-center justify-content-center"><img class="profile-avatar rounded-circle" alt="Tom Ralph" src="" loading="lazy"
  
   />
</div>
    <div class="col-12 profile-meta"><div class="profile-name">Tom Ralph</div><div class="profile-bio">things</div></div>
  </div>
</section>
  <section class="recent-posts row card component">
  <div class="card-body">
    <h2 class="card-title">Recent Posts</h2>
    <ul><li><a href="/posts/secondpost/">Second post
</a></li><li><a href="/posts/firstpost/">Firstpost
</a></li><li><a href="/posts/2017-08-30-vsphere-6-5-top-kb-articles-for-upgrade-prep/">vSphere 6.5 - Top KB Articles for Upgrade Prep
</a></li><li><a href="/posts/2014-04-21-2014421mass-update-media-in-vcloud-dicrector/">Mass Update Media in vCloud Dicrector
</a></li><li><a href="/posts/2014-04-16-2014416relocating-a-vm-in-vcloud-director/">Relocating a VM in vCloud Director
</a></li></ul>
  </div>
</section><section class="taxonomies row card component">
      <div class="card-body">
        <h2 class="card-title">
          <a href="/categories">Categories</a>
        </h2>
        <div><a href="/categories/vmware-vsphere/" class="badge bg-primary text-white rounded post-taxonomy" title="vmware-vsphere">
            vmware-vsphere
          </a><a href="/categories/vmware-vcloud/" class="badge bg-primary text-white rounded post-taxonomy" title="vmware-vcloud">
            vmware-vcloud
          </a><a href="/categories/technology/" class="badge bg-primary text-white rounded post-taxonomy" title="technology">
            technology
          </a><a href="/categories/microsoft-hyper-v/" class="badge bg-primary text-white rounded post-taxonomy" title="microsoft-hyper-v">
            microsoft-hyper-v
          </a><a href="/categories/personal/" class="badge bg-primary text-white rounded post-taxonomy" title="personal">
            personal
          </a><a href="/categories/vcdx-process/" class="badge bg-primary text-white rounded post-taxonomy" title="vcdx-process">
            vcdx-process
          </a><a href="/categories/apple-ios/" class="badge bg-primary text-white rounded post-taxonomy" title="apple-ios">
            apple-ios
          </a><a href="/categories/vmware-vc-ops/" class="badge bg-primary text-white rounded post-taxonomy" title="vmware-vc-ops">
            vmware-vc-ops
          </a><a href="/categories/vmware-vcm/" class="badge bg-primary text-white rounded post-taxonomy" title="vmware-vcm">
            vmware-vcm
          </a><a href="/categories/vmworld/" class="badge bg-primary text-white rounded post-taxonomy" title="vmworld">
            vmworld
          </a></div>
      </div>
    </section><section class="taxonomies row card component">
      <div class="card-body">
        <h2 class="card-title">
          <a href="/tags">Tags</a>
        </h2>
        <div><a href="/tags/vcloud/" class="badge bg-primary text-white rounded post-taxonomy" title="vcloud">
            vcloud
          </a><a href="/tags/powershell/" class="badge bg-primary text-white rounded post-taxonomy" title="powershell">
            powershell
          </a><a href="/tags/vsphere/" class="badge bg-primary text-white rounded post-taxonomy" title="vsphere">
            vsphere
          </a><a href="/tags/vcenter/" class="badge bg-primary text-white rounded post-taxonomy" title="vcenter">
            vcenter
          </a><a href="/tags/security/" class="badge bg-primary text-white rounded post-taxonomy" title="security">
            security
          </a><a href="/tags/vcdx/" class="badge bg-primary text-white rounded post-taxonomy" title="vcdx">
            vcdx
          </a><a href="/tags/vmware/" class="badge bg-primary text-white rounded post-taxonomy" title="vmware">
            vmware
          </a><a href="/tags/vshield/" class="badge bg-primary text-white rounded post-taxonomy" title="vshield">
            vshield
          </a><a href="/tags/vsphere-5/" class="badge bg-primary text-white rounded post-taxonomy" title="vsphere-5">
            vsphere-5
          </a><a href="/tags/change/" class="badge bg-primary text-white rounded post-taxonomy" title="change">
            change
          </a></div>
      </div>
    </section>
    
  </div>
</aside>
</div>
    </main><footer class="footer mt-auto py-3 text-center container"><nav class="social-links nav my-2 justify-content-center"><a class="nav-link social-link" href="mailto:tom@thevsg.co" title="Email">
      <i class="fas fa-fw fa-2x fa-envelope"></i>
    </a></nav>
<div class="copyright mb-2">
  Copyright © 2020-2021 Tom Ralph. All Rights Reserved.
</div>
<div class="powered-by mb-2">
  Powered by <a href="https://gohugo.io" target="_blank" rel="noopener noreferrer">Hugo</a> and the <a href="https://github.com/razonyang/hugo-theme-bootstrap" target="_blank" rel="noopener noreferrer">Bootstrap</a> theme.
</div></footer>
<script src="/js/bundle.min.425550fc2a278561fe029578aa420a6953a8c62479f57ea3cbd6b0fc8557b403.js" integrity="sha256-QlVQ/ConhWH&#43;ApV4qkIKaVOoxiR59X6jy9aw/IVXtAM=" crossorigin="anonymous" defer></script><script defer src="/js/viewer.min.2f6511f1e2b87cdacb7bdeedeadc1dcf2fc9f22db69f89b70fd5d91224f892a4.js" integrity="sha256-L2UR8eK4fNrLe97t6twdzy/J8i22n4m3D9XZEiT4kqQ=" crossorigin="anonymous"></script>
</body>
</html>
